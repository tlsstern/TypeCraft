<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>typecraft</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/minecraft-4" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/minecraftia" rel="stylesheet">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 60'><rect x='5' y='5' width='90' height='50' rx='5' fill='%23B8B8B8' stroke='black' stroke-width='4'/><rect x='15' y='15' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='28' y='15' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='41' y='15' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='54' y='15' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='67' y='15' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='80' y='15' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='15' y='28' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='28' y='28' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='41' y='28' width='20' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='67' y='28' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='80' y='28' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='15' y='41' width='30' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='50' y='41' width='8' height='8' fill='white' stroke='black' stroke-width='2'/><rect x='63' y='41' width='25' height='8' fill='white' stroke='black' stroke-width='2'/></svg>"
        type="image/svg+xml">
</head>

<body>
    <video id="bg-video" autoplay loop muted>
        <source src="background/background.mp4" type="video/mp4">
    </video>
    <div class="title-screen-content">
        <img class="title-image" src="background/title.png" alt="Title">

        <div class="main-menu-buttons">
            <button class="menu-button singleplayer-btn">Singleplayer</button>
            <button class="menu-button leaderboard-btn" id="leaderboardBtn">
                <span class="material-icons">leaderboard</span>
                Leaderboard
            </button>
            <div class="bottom-row-buttons">
                <button class="menu-button options-btn">Options...</button>
                <button class="menu-button quit-btn">Quit Game</button>
            </div>
        </div>

        <div class="bottom-left-controls">
            <div id="userDisplay">
                <!-- User display populated by auth-check.js -->
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-content">
            <div class="profile-header">
                <h1>Profile</h1>
                <button class="close-button" id="closeProfile">Ã—</button>
            </div>

            <div class="profile-info">
                <div class="profile-avatar">
                    <span class="material-icons profile-avatar-icon" id="profileAvatarIcon">account_circle</span>
                </div>
                <h2 id="profileUsername">Guest</h2>
                <p id="profileEmail"></p>
            </div>

            <div class="profile-stats" id="profileStats">
                <h3>Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Total Tests</span>
                        <span class="stat-value" id="profileTotalTests">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Top Speed</span>
                        <span class="stat-value" id="profileTopSpeed">0 WPM</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Average WPM</span>
                        <span class="stat-value" id="profileAvgWPM">0 WPM</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Average Accuracy</span>
                        <span class="stat-value" id="profileAvgAccuracy">0%</span>
                    </div>
                </div>
            </div>

            <div class="profile-actions">
                <button class="menu-button" id="profileViewLeaderboard" onclick="openLeaderboard(); closeProfileModal();">
                    <span class="material-icons">leaderboard</span>
                    View Leaderboard
                </button>
                <button class="menu-button profile-logout-btn" id="profileLogoutBtn" style="display: none;">
                    <span class="material-icons">logout</span>
                    Logout
                </button>
                <button class="menu-button profile-signin-btn" id="profileSigninBtn" style="display: none;">
                    <span class="material-icons">login</span>
                    Sign In to Save Progress
                </button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="leaderboard-modal">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <h1>Leaderboard</h1>
                <button class="close-button" id="closeLeaderboard">Ã—</button>
            </div>

            <div class="leaderboard-controls">
                <select id="leaderboardFilter" class="leaderboard-select">
                    <option value="all-time">All Time</option>
                    <option value="monthly">This Month</option>
                    <option value="weekly">This Week</option>
                </select>
                <button class="refresh-button" id="refreshLeaderboard">
                    <span class="material-icons">refresh</span>
                </button>
            </div>

            <div class="leaderboard-table-container">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Top WPM</th>
                            <th>Avg WPM</th>
                            <th>Tests</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody">
                        <tr>
                            <td colspan="5" class="loading-cell">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="leaderboard-pagination">
                <button id="prevPage" class="pagination-btn" disabled>Previous</button>
                <span id="pageInfo">Page 1</span>
                <button id="nextPage" class="pagination-btn">Next</button>
            </div>
        </div>
    </div>

    <!-- Options Modal -->
    <div id="optionsModal" class="options-modal">
        <div class="options-content">
            <h1 class="options-title">Options</h1>

            <div class="options-sections">
                <!-- Theme Settings -->
                <div class="options-section">
                    <h2 class="section-title">Appearance</h2>
                    <div class="setting-item">
                        <label for="themeSelect">Theme</label>
                        <select id="themeSelect" class="theme-dropdown">
                            <option value="cherry">Cherry</option>
                            <option value="end">End</option>
                            <option value="nether">Nether</option>
                            <option value="overworld">Overworld</option>
                        </select>
                    </div>
                </div>

                <!-- Audio Settings -->
                <div class="options-section">
                    <h2 class="section-title">Audio</h2>
                    <div class="setting-item">
                        <label for="masterVolume">Master Volume</label>
                        <div class="slider-container">
                            <input type="range" id="masterVolume" min="0" max="100" value="70">
                            <span class="slider-value">70%</span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="sfxVolume">Sound Effects</label>
                        <div class="slider-container">
                            <input type="range" id="sfxVolume" min="0" max="100" value="50">
                            <span class="slider-value">50%</span>
                        </div>
                    </div>
                </div>

                <!-- Test Settings -->
                <div class="options-section">
                    <h2 class="section-title">Test Settings</h2>
                    <div class="setting-item">
                        <label for="testDuration">Test Duration</label>
                        <select id="testDuration" class="theme-dropdown">
                            <option value="10">10 seconds</option>
                            <option value="15">15 seconds</option>
                            <option value="30">30 seconds</option>
                            <option value="60" selected>60 seconds</option>
                            <option value="120">2 minutes</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="options-buttons">
                <button class="menu-button options-done-btn">Done</button>
                <button class="menu-button options-reset-btn">Reset to Default</button>
            </div>

            <!-- Account section (shown only when logged in) -->
            <div id="accountSection" class="account-section" style="display: none;">
                <div class="account-divider"></div>
                <div class="account-info">
                    <span id="userEmailDisplay"></span>
                </div>
                <button class="menu-button options-logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="TypeCraftBackend/auth-check.js"></script>
    <script src="TypeCraftBackend/supabase-data.js"></script>
    <script>
        function applyTheme(themeName) {
            document.body.setAttribute('data-theme', themeName);
        }
    </script>
    <script>
        document.querySelector('.singleplayer-btn').addEventListener('click', function () {
            window.location.href = 'typing.html';
        });

        document.querySelector('.quit-btn').addEventListener('click', function () {
            // Try to close the window/tab
            window.close();

            // If window.close() doesn't work (most browsers block it for security),
            // redirect to a blank page as fallback
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 100);
        });

        // Define settings functions in global scope
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('typeCraftSettings')) || {};

            if (settings.masterVolume !== undefined) {
                document.getElementById('masterVolume').value = settings.masterVolume;
                document.querySelector('#masterVolume + .slider-value').textContent = settings.masterVolume + '%';
            }
            if (settings.sfxVolume !== undefined) {
                document.getElementById('sfxVolume').value = settings.sfxVolume;
                document.querySelector('#sfxVolume + .slider-value').textContent = settings.sfxVolume + '%';
            }
            if (settings.theme !== undefined) {
                document.getElementById('themeSelect').value = settings.theme;
            }
            // Load test duration
            const savedTime = localStorage.getItem('selectedTime');
            if (savedTime) {
                document.getElementById('testDuration').value = savedTime;
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            const settings = {
                masterVolume: parseInt(document.getElementById('masterVolume').value),
                sfxVolume: parseInt(document.getElementById('sfxVolume').value),
                theme: document.getElementById('themeSelect').value
            };

            localStorage.setItem('typeCraftSettings', JSON.stringify(settings));
            localStorage.setItem('selectedTheme', settings.theme);

            // Save test duration
            const testDuration = document.getElementById('testDuration').value;
            localStorage.setItem('selectedTime', testDuration);
        }

        // Reset settings to default
        function resetSettings() {
            localStorage.removeItem('typeCraftSettings');
            localStorage.setItem('selectedTheme', 'cherry');
            localStorage.setItem('selectedTime', '60');

            // Reset UI
            document.getElementById('masterVolume').value = 70;
            document.querySelector('#masterVolume + .slider-value').textContent = '70%';
            document.getElementById('sfxVolume').value = 50;
            document.querySelector('#sfxVolume + .slider-value').textContent = '50%';
            document.getElementById('themeSelect').value = 'cherry';
            document.getElementById('testDuration').value = '60';

            // Apply cherry theme
            if (typeof applyTheme === 'function') {
                applyTheme('cherry');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Options Modal Functionality
            const optionsModal = document.getElementById('optionsModal');
            const optionsBtn = document.querySelector('.options-btn');
            const optionsDoneBtn = document.querySelector('.options-done-btn');
            const optionsResetBtn = document.querySelector('.options-reset-btn');

            if (!optionsModal || !optionsBtn || !optionsDoneBtn || !optionsResetBtn) {
                console.error('Options modal elements not found');
                return;
            }

            optionsBtn.addEventListener('click', function () {
                loadSettings(); // Reload settings when opening modal
                optionsModal.style.display = 'flex';
            });

            optionsDoneBtn.addEventListener('click', function () {
                saveSettings();
                optionsModal.style.display = 'none';
            });

            optionsResetBtn.addEventListener('click', function () {
                if (confirm('Reset all settings to default?')) {
                    resetSettings();
                }
            });

            // Theme selector change handler
            const themeSelect = document.getElementById('themeSelect');
            themeSelect.addEventListener('change', function () {
                applyTheme(this.value);
            });

            // Test duration selector change handler
            const testDuration = document.getElementById('testDuration');
            testDuration.addEventListener('change', function () {
                localStorage.setItem('selectedTime', this.value);
            });

            // Close modal when clicking outside
            optionsModal.addEventListener('click', function (e) {
                if (e.target === optionsModal) {
                    saveSettings();
                    optionsModal.style.display = 'none';
                }
            });

            // Toggle buttons functionality
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const isEnabled = this.getAttribute('data-enabled') === 'true';
                    this.setAttribute('data-enabled', !isEnabled);
                    this.textContent = !isEnabled ? 'ON' : 'OFF';
                    this.classList.toggle('disabled', isEnabled);
                });
            });

            // Slider value display
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const valueDisplay = slider.nextElementSibling;
                slider.addEventListener('input', function () {
                    valueDisplay.textContent = this.value + '%';
                });
            });

            // Load settings on page load
            loadSettings();

            // Apply saved theme on page load
            const savedTheme = localStorage.getItem('selectedTheme') || 'cherry';
            applyTheme(savedTheme);

            // Leaderboard functionality
            initializeLeaderboard();
        });

        // Profile Modal Management
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            if (!modal) return;

            modal.classList.add('active');

            // Get current user/guest status
            const user = window.authCheck?.getCurrentUser();
            const isGuestMode = window.authCheck?.isGuest();

            if (user) {
                // Logged in user
                document.getElementById('profileAvatarIcon').textContent = 'account_circle';
                document.getElementById('profileUsername').textContent = user.email.split('@')[0];
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileEmail').style.display = 'block';

                // Show logout button, hide signin
                document.getElementById('profileLogoutBtn').style.display = 'flex';
                document.getElementById('profileSigninBtn').style.display = 'none';

                // Load user statistics
                loadUserStats();
            } else {
                // Guest mode
                document.getElementById('profileAvatarIcon').textContent = 'person_outline';
                document.getElementById('profileUsername').textContent = 'Guest';
                document.getElementById('profileEmail').textContent = '';
                document.getElementById('profileEmail').style.display = 'none';

                // Show signin button, hide logout
                document.getElementById('profileLogoutBtn').style.display = 'none';
                document.getElementById('profileSigninBtn').style.display = 'flex';

                // Show guest message for stats
                showGuestStats();
            }
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        async function loadUserStats() {
            try {
                if (window.supabaseData) {
                    const result = await window.supabaseData.getUserStats();

                    if (result.data) {
                        document.getElementById('profileTotalTests').textContent = result.data.total_runs || 0;
                        document.getElementById('profileTopSpeed').textContent = Math.round(result.data.top_speed || 0) + ' WPM';
                        document.getElementById('profileAvgWPM').textContent = Math.round(result.data.average_wpm || 0) + ' WPM';
                        document.getElementById('profileAvgAccuracy').textContent = (result.data.average_accuracy || 0).toFixed(1) + '%';
                    } else {
                        // No stats yet
                        document.getElementById('profileTotalTests').textContent = '0';
                        document.getElementById('profileTopSpeed').textContent = '0 WPM';
                        document.getElementById('profileAvgWPM').textContent = '0 WPM';
                        document.getElementById('profileAvgAccuracy').textContent = '0%';
                    }
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        function showGuestStats() {
            document.getElementById('profileTotalTests').textContent = '-';
            document.getElementById('profileTopSpeed').textContent = '-';
            document.getElementById('profileAvgWPM').textContent = '-';
            document.getElementById('profileAvgAccuracy').textContent = '-';
        }

        // Initialize profile modal
        document.addEventListener('DOMContentLoaded', () => {
            const closeProfileBtn = document.getElementById('closeProfile');
            const profileModal = document.getElementById('profileModal');
            const profileLogoutBtn = document.getElementById('profileLogoutBtn');
            const profileSigninBtn = document.getElementById('profileSigninBtn');

            if (closeProfileBtn) {
                closeProfileBtn.addEventListener('click', closeProfileModal);
            }

            if (profileModal) {
                profileModal.addEventListener('click', (e) => {
                    if (e.target === profileModal) {
                        closeProfileModal();
                    }
                });
            }

            if (profileLogoutBtn) {
                profileLogoutBtn.addEventListener('click', logout);
            }

            if (profileSigninBtn) {
                profileSigninBtn.addEventListener('click', () => {
                    // Clear guest mode flag before redirecting to login
                    localStorage.removeItem('skipAuth');
                    window.location.href = 'login.html';
                });
            }
        });

        // Leaderboard Manager
        let currentPage = 1;
        const itemsPerPage = 10;

        function initializeLeaderboard() {
            const leaderboardBtn = document.getElementById('leaderboardBtn');
            const leaderboardModal = document.getElementById('leaderboardModal');
            const closeLeaderboard = document.getElementById('closeLeaderboard');
            const refreshButton = document.getElementById('refreshLeaderboard');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');

            if (leaderboardBtn) {
                leaderboardBtn.addEventListener('click', openLeaderboard);
            }

            if (closeLeaderboard) {
                closeLeaderboard.addEventListener('click', closeLeaderboardModal);
            }

            if (leaderboardModal) {
                leaderboardModal.addEventListener('click', (e) => {
                    if (e.target === leaderboardModal) {
                        closeLeaderboardModal();
                    }
                });
            }

            if (refreshButton) {
                refreshButton.addEventListener('click', () => loadLeaderboard(currentPage));
            }

            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        loadLeaderboard(currentPage);
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    currentPage++;
                    loadLeaderboard(currentPage);
                });
            }
        }

        async function openLeaderboard() {
            const modal = document.getElementById('leaderboardModal');
            if (modal) {
                modal.classList.add('active');
                currentPage = 1;
                await loadLeaderboard(currentPage);
            }
        }

        function closeLeaderboardModal() {
            const modal = document.getElementById('leaderboardModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        async function loadLeaderboard(page = 1) {
            const tableBody = document.getElementById('leaderboardTableBody');
            if (!tableBody) return;

            // Show loading
            tableBody.innerHTML = '<tr><td colspan="5" class="loading-cell">Loading...</td></tr>';

            try {
                const offset = (page - 1) * itemsPerPage;
                const result = await window.supabaseData.getLeaderboard(itemsPerPage, offset);

                if (result.error) {
                    throw new Error(result.error);
                }

                const leaderboardData = result.data || [];

                if (leaderboardData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="empty-cell">No leaderboard data available yet. Be the first to set a record!</td></tr>';
                    updatePaginationButtons(false, false);
                    return;
                }

                // Render leaderboard
                renderLeaderboard(leaderboardData, offset);

                // Update pagination
                const hasNext = leaderboardData.length === itemsPerPage;
                const hasPrev = page > 1;
                updatePaginationButtons(hasPrev, hasNext);

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="error-cell">Failed to load leaderboard. Please try again.</td></tr>';
            }
        }

        function renderLeaderboard(data, offset) {
            const tableBody = document.getElementById('leaderboardTableBody');
            const currentUserId = window.authCheck?.getCurrentUser()?.id;

            tableBody.innerHTML = '';

            data.forEach((entry, index) => {
                const rank = offset + index + 1;
                const isCurrentUser = currentUserId && entry.user_id === currentUserId;

                const row = document.createElement('tr');
                if (isCurrentUser) {
                    row.classList.add('current-user');
                }

                const rankDisplay = getRankDisplay(rank);
                const username = entry.username || entry.email || 'Anonymous';
                const displayName = username.length > 20 ? username.substring(0, 17) + '...' : username;

                row.innerHTML = `
                    <td class="rank-cell">${rankDisplay}</td>
                    <td class="username-cell">${displayName}${isCurrentUser ? ' <span class="you-badge">YOU</span>' : ''}</td>
                    <td class="wpm-cell">${Math.round(entry.top_speed || 0)}</td>
                    <td class="wpm-cell">${Math.round(entry.average_wpm || 0)}</td>
                    <td class="tests-cell">${entry.total_runs || 0}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        function getRankDisplay(rank) {
            if (rank === 1) return 'ðŸ¥‡';
            if (rank === 2) return 'ðŸ¥ˆ';
            if (rank === 3) return 'ðŸ¥‰';
            return `#${rank}`;
        }

        function updatePaginationButtons(hasPrev, hasNext) {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');

            if (prevBtn) prevBtn.disabled = !hasPrev;
            if (nextBtn) nextBtn.disabled = !hasNext;
            if (pageInfo) pageInfo.textContent = `Page ${currentPage}`;
        }
    </script>
</body>

</html>